language: ruby
rvm:
 - 2.7.1

env:
  - CC_TEST_REPORTER_ID=e459b339289caeadc028552d603c6465c5aadcffedbdcf960d4e2c66966c03ae

addons:
  apt:
    packages:
      - libqtwebkit-dev

services:
  - postgresql

before_install:
  - nvm install 14

before_script:
  - psql -c 'create database myapp_development;' -U postgres
  - psql -c 'create database myapp_test;' -U postgres
  - psql -c 'create database myapp_production;' -U postgres
  - rake db:migrate RAILS_ENV=test
  - yarn install
  - NODE_ENV=test bundle exec rails webpacker:compile
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

script:
  - bundle exec rake spec
  - xvfb-run -a bundle exec rake cucumber

after_script:
  - ./cc-test-reporter format-coverage -t simplecov -o coverage/codeclimate.backend.json coverage/backend/.resultset.json
  - ./cc-test-reporter format-coverage -t lcov -o coverage/codeclimate.frontend.json coverage/frontend/lcov.info
  - ./cc-test-reporter sum-coverage coverage/codeclimate.*.json -p 2
  - if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then ./cc-test-reporter upload-coverage; fi